<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lawrence</title>
    <!-- Lien vers le fichier CSS -->
    <link rel="stylesheet" href="/style/style.css" />
  </head>
  <body>
    <!-- Formulaire de Connexion -->
    <div id="login-form" class="form-container">
      <h2 class="form-title">Connexion</h2>

      <!-- Interrupteur pour choisir entre Email et Username -->
      <div class="form-group">
        <label for="toggle-switch">Changer la méthode de connexion</label>
        <label class="switch">
          <input type="checkbox" id="toggle-switch" />
          <span class="slider round"></span>
        </label>
      </div>

      <!-- Champs Email et Username -->
      <div class="form-group">
        <label for="email" id="email-label">Email</label>
        <input
          type="email"
          id="email-input"
          placeholder="Email"
          autocomplete="off"
          required
        />

        <label for="username" id="username-label" class="hidden"
          >Nom d'utilisateur</label
        >
        <input
          type="text"
          id="username-input"
          placeholder="Nom d'utilisateur"
          autocomplete="off"
          class="hidden"
        />
      </div>

      <div class="form-group">
        <label for="password">Mot de passe</label>
        <input
          type="password"
          id="password"
          placeholder="Mot de passe"
          autocomplete="off"
          required
        />
      </div>

      <button id="login-button">Connexion</button>
      <button id="switch-to-register" class="switch-button">
        Créer un compte
      </button>
      <div id="login-message" class="message"></div>
    </div>
    <script>
      // Gestion du slider pour basculer entre Email et Username
      document.getElementById("toggle-switch").addEventListener("change", function () {
        const emailInput = document.getElementById("email-input");
        const usernameInput = document.getElementById("username-input");
        const emailLabel = document.getElementById("email-label");
        const usernameLabel = document.getElementById("username-label");
    
        if (this.checked) {
          // Si le slider est activé, utiliser le nom d'utilisateur
          emailInput.classList.add("hidden");
          emailLabel.classList.add("hidden");
          usernameInput.classList.remove("hidden");
          usernameLabel.classList.remove("hidden");
        } else {
          // Si le slider est désactivé, utiliser l'email
          emailInput.classList.remove("hidden");
          emailLabel.classList.remove("hidden");
          usernameInput.classList.add("hidden");
          usernameLabel.classList.add("hidden");
        }
      });
    
      // Requête POST pour la connexion
      document.getElementById("login-button").addEventListener("click", function (event) {
        event.preventDefault();
    
        const toggleSwitch = document.getElementById("toggle-switch").checked;
        const password = document.getElementById("password").value;
    
        // Choisir le champ email ou username selon l'état du switch
        let data = {
          password: password,
        };
    
        if (toggleSwitch) {
          // Si le slider est activé, on envoie le nom d'utilisateur
          const username = document.getElementById("username-input").value;
          data.username = username;
        } else {
          // Sinon, on envoie l'email
          const email = document.getElementById("email-input").value;
          data.email = email;
        }
    
        // Envoi de la requête POST pour la connexion
        fetch("http://192.168.65.103:5560/login", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
        })
          .then((response) => response.json())
          .then((result) => {
            const loginMessage = document.getElementById("login-message");
            if (result.success && result.token) {
              // Enregistrer le token dans un cookie si la connexion est réussie
              document.cookie = `token=${result.token}; path=/;`;
    
              // Vérifier si le token est bien enregistré en cookie
              if (document.cookie.includes("token")) {
                // Rediriger vers la page home.html si le token est présent
                window.location.href = "home.html";
              } else {
                loginMessage.textContent = "Échec de l'enregistrement du token.";
                loginMessage.style.color = "red";
              }
            } else {
              // Afficher le message d'erreur si la connexion échoue
              loginMessage.textContent = result.message || "Identifiants invalides.";
              loginMessage.style.color = "red";
            }
          })
          .catch((error) => {
            console.error("Erreur lors de la connexion:", error);
            document.getElementById("login-message").textContent =
              "Une erreur est survenue. Veuillez réessayer.";
            document.getElementById("login-message").style.color = "red";
          });
      });
    </script>
    <!-- Formulaire de Création de Compte -->
    <div id="register-form" class="form-container hidden">
      <h2 class="form-title">Inscription</h2>
      <p id="result_label"></p>
      <div class="form-group">
        <label for="username">Nom d'utilisateur</label>
        <input
          type="text"
          id="username"
          placeholder="Nom d'utilisateur"
          autocomplete="off"
          required
        />
      </div>
      <div class="form-group">
        <label for="register-email">Email</label>
        <input
          type="email"
          id="register-email"
          placeholder="Email"
          autocomplete="off"
          required
        />
      </div>
      <div class="form-group">
        <label for="register-password">Mot de passe</label>
        <input
          type="password"
          id="register-password"
          placeholder="Mot de passe"
          autocomplete="off"
          required
        />
      </div>
      <button id="register-button" type="submit">Inscription</button>
      <button id="switch-to-login" class="switch-button">
        Retour à la connexion
      </button>
      <div id="register-message" class="message"></div>
    </div>
    
    <!-- Lien vers le fichier JavaScript -->
    <script>
      document
        .getElementById("register-button")
        .addEventListener("click", function (event) {
          event.preventDefault();

          const username = document.getElementById("username").value;
          const email = document.getElementById("register-email").value;
          const password = document.getElementById("register-password").value;

          // Création de l'objet JSON à envoyer
          const data = {
            user: username,
            email: email,
            password: password,
          };

          // Envoi de la requête POST
          fetch("http://192.168.65.103:5560/register", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
          })
            .then((response) => response.json())
            .then((result) => {
              const resultLabel = document.getElementById("result_label");
              if (result.success) {
                // Si réussite, vider les champs et afficher un message
                document.getElementById("username").value = "";
                document.getElementById("mail").value = "";
                document.getElementById("password").value = "";
                resultLabel.textContent = "Compte créé avec succès !";
                resultLabel.style.color = "green";
              } else {
                // Si erreur, afficher un message et vider les champs invalides
                resultLabel.textContent = result.message;
                resultLabel.style.color = "black";
                if (result.errorField === "username") {
                  document.getElementById("username").value = "";
                }
                if (result.errorField === "email") {
                  document.getElementById("register-email").value = "";
                }
                if (result.errorField === "password") {
                  document.getElementById("register-password").value = "";
                }
              }
            })
            .catch((error) => {
              console.error("Erreur lors de l'inscription:", error);
              document.getElementById("result_label").textContent =
                "Une erreur est survenue. Veuillez réessayer.";
              document.getElementById("result_label").style.color = "red";
            });
        });
    </script>
    <script src="/script/main.js"></script>
  </body>
</html>
